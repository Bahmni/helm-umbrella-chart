name: Trivy Security Scan

on:
  push:
    branches:
      - BAH-2136
    paths:
      - .github/workflows/trivy-scan.yaml

  workflow_dispatch:

jobs:
  trivy-scan:
    name: Trivy Scan
    runs-on: ubuntu-latest
    env:
      CLUSTER_NAME: bahmni-cluster-nonprod
    steps:
      - name: Setup Trivy
        run: brew install aquasecurity/trivy/trivy
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.BAHMNI_AWS_ID }}
          aws-secret-access-key: ${{ secrets.BAHMNI_AWS_SECRET }}
          aws-region: ${{ secrets.BAHMNI_AWS_REGION }}
          role-to-assume: ${{ secrets.BAHMNI_INFRA_ADMIN_ROLE }}
          role-duration-seconds: 900 # 15 mins
          role-session-name: BahmniInfraAdminSession
      - name: Authorise Kubectl with EKS
        run: aws eks update-kubeconfig --name $CLUSTER_NAME

      - name: Create reports directory
        run: mkdir reports

      - name: Run Trivy Detailed Scan
        run: trivy k8s --no-progress --report=all --timeout=1h cluster -o reports/trivy-detailed-report.txt

      - name: Run Trivy Summary Scan
        run: trivy k8s --no-progress --report=summary --timeout=1h cluster -o reports/trivy-summary-report.txt

      - name: Upload Report Artifact
        uses: actions/upload-artifact@v3
        with:
          name: trivy-reports
          path: reports/

